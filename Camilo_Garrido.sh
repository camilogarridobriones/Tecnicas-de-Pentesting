#!/bin/bash

# VARIABLES GLOBALES


#FUNCTION CTRL-C
trap ctrl_c INT
function ctrl_c(){
	echo "[$(tput setaf 9)Error$(tput sgr0)] Exiting ...";
	sleep 1
	_die
}

function _Camilo_Garrido_Scan() {
	fqdn=$1

	if [ -z "$fqdn" ]; then
		echo "[$(tput setaf 8)INFO$(tput sgr0)] Usage: $0 -d www.umayor.cl"
		exit 1
	fi

	ip=$(host -t A $fqdn | awk '{print $NF}')

	if [[ $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
		echo -e "[$(tput setaf 8)INFO$(tput sgr0)] Comenzando con el Análisis sobre $ip"
	else
		echo -e "[$(tput setaf 9)ERROR$(tput sgr0)] FQDN no encontrado"
		exit
	fi

	echo -e "[$(tput setaf 13)tools$(tput sgr0)] reconocimiento de puertos ..."
	nmap -sS --min-rate 5000 --open -n -p- --open $ip -oG /tmp/allPorts >/dev/null
	sleep 1
	ports="$(cat /tmp/allPorts | grep -oP '\d{1,5}/open' | awk '{print $1}' FS='/' | xargs | tr ' ' ',')"

	echo -e "  [$(tput setaf 46)*$(tput sgr0)] Open ports: $ports"
	sleep 1

	echo -e "[$(tput setaf 13)tools$(tput sgr0)] script de enumeración ..."
	sleep 1
	xterm -T 'ENUMERACIÓN' -hold -e "nmap -sC -sV -p$ports $ip -oX /tmp/portExploit.xml" &
	sleep 2

		pgrep nmap >/dev/null
		while [ $? -eq 0 ]; do
			sleep 5
			pgrep nmap >/dev/null
		done

	echo -e "[$(tput setaf 13)tools$(tput sgr0)] whatweb"
	xterm -T "EXPLORACIÓN WEB" -hold -e "whatweb -v -a 3 http://$fqdn" &

		pgrep whatweb >/dev/null
		while [ $? -eq 0 ];do
			sleep 5
			pgrep whatweb >/dev/null
		done

	echo -e "[$(tput setaf 13)tools$(tput sgr0)] shodan"
	xterm -T 'EXPLORACIÓN SHODAN' -hold -e "sleep 2; curl -s -k -X $'GET' 'https://api.shodan.io/shodan/host/$ip?key=MM72AkzHXdHpC8iP65VVEEVrJjp7zkgd&minify=true' | jq" &
	sleep 3

	echo -e "[$(tput setaf 13)tools$(tput sgr0)] search exploit"
	sleep 1
	xterm -T 'BUSQUEDA DE EXPLOIT' -hold -e "sleep 2; searchsploit --nmap /tmp/portExploit.xml" &
	sleep 3
	echo -e "[$(tput setaf 8)INFO$(tput sgr0)] Finalizando Análisis"
	sleep 2

	rm /tmp/allPorts 2>/dev/null
	rm /tmp/portExploit.xml 2>/dev/null
	exit 1

}

function _usage() {
	echo "$(tput setaf 100) Usage: $0 [options] $(tput sgr0)"
	echo "$(tput setaf 100)  -d [FQDN] $(tput sgr0)"
	echo "$(tput setaf 100)  -h [helpPanel] $(tput sgr0)"
	echo
}


## MAIN FUNCTION
if [ $(id -u) -eq 0 ]; then

	while getopts ":dh:" arg; do
		case $arg in
			d) _Camilo_Garrido_Scan $2 ;;			# scan top 5000 port nmap
			h|*) _usage ;;
		esac
	done
else
	echo "[$(tput setaf 9)Error$(tput sgr0)] You must be root!"
fi
